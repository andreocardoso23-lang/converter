<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Conversor Extrato Bancário PDF → Excel (Padrão Contábil)</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:30px; }
    .box { max-width:1000px; margin:auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,.08); }
    h1 { margin-top:0; font-size:22px; }
    button { padding:10px 18px; border:none; background:#1976d2; color:#fff; border-radius:4px; cursor:pointer; }
    button:disabled { background:#999; }
    .log { margin-top:20px; font-size:12px; background:#f1f1f1; padding:10px; height:180px; overflow-y:auto; }
  </style>
</head>
<body>

<div class="box">
  <h1>Conversor de Extrato Bancário (PDF → Excel)</h1>
  <p>Padrão idêntico ao modelo informado (com linhas de saldo).<br>
     Sem cálculo, sem ordenação, sem consolidação.</p>

  <input type="file" id="pdfInput" accept="application/pdf"><br><br>
  <button id="btn" disabled>Converter para Excel</button>

  <div class="log" id="log"></div>
</div>

<script>
const input = document.getElementById('pdfInput');
const btn = document.getElementById('btn');
const log = document.getElementById('log');
let file;

input.addEventListener('change', e => {
  file = e.target.files[0];
  btn.disabled = !file;
});

function writeLog(msg) {
  log.innerHTML += msg + '<br>';
  log.scrollTop = log.scrollHeight;
}

function isCPFouCNPJ(text) {
  return /(\d{3}\.\d{3}\.\d{3}-\d{2})|(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/.test(text);
}

btn.addEventListener('click', async () => {
  log.innerHTML = '';
  writeLog('Carregando PDF...');

  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

  const rows = [];
  rows.push(['Data','Descrição','Documento','Valor (R$)','Saldo (R$)']);

  for (let p = 1; p <= pdf.numPages; p++) {
    writeLog('Lendo página ' + p);
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    const lines = {};
    content.items.forEach(item => {
      const y = Math.round(item.transform[5]);
      if (!lines[y]) lines[y] = [];
      lines[y].push(item.str);
    });

    const orderedY = Object.keys(lines).map(Number).sort((a,b)=>b-a);

    orderedY.forEach(y => {
      const line = lines[y].join(' ').replace(/\s+/g,' ').trim();
      if (!line) return;

      // Data no início
      const dateMatch = line.match(/^\d{2}\/\d{2}\/\d{4}/);
      if (!dateMatch) return;

      const data = dateMatch[0];
      let rest = line.replace(data,'').trim();

      // Valor (último número da linha)
      const valorMatch = rest.match(/-?\d{1,3}(?:\.\d{3})*,\d{1,2}$/);
      let valor = '';
      if (valorMatch) {
        valor = valorMatch[0];
        rest = rest.replace(valor,'').trim();
      }

      // Documento (CPF/CNPJ se existir)
      let documento = '';
      const docMatch = rest.match(/(\d{3}\.\d{3}\.\d{3}-\d{2}|\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/);
      if (docMatch) {
        documento = docMatch[0];
        rest = rest.replace(documento,'').trim();
      }

      let descricao = rest;
      let saldo = '';

      if (descricao.toUpperCase().includes('SALDO TOTAL DISPONÍVEL DIA') || descricao.toUpperCase().includes('SALDO ANTERIOR')) {
        saldo = valor;
        valor = '';
      }

      rows.push([data, descricao, documento, valor, saldo]);
    });
  }

  writeLog('Gerando Excel...');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Extrato');
  XLSX.writeFile(wb, 'Extrato_Modelo_Contabil.xlsx');
  writeLog('Conversão finalizada com sucesso.');
});
</script>

</body>
</html>
